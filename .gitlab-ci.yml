# GitLab CI/CD Pipeline for React Cafe Project
# This pipeline includes stages for install, test, build, and deploy

stages:
  - install
  - test
  - build
  - deploy

# Cache node_modules to speed up builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

# Variables
variables:
  NODE_VERSION: "16"
  CI: "true"

# Install dependencies
install_dependencies:
  stage: install
  image: node:${NODE_VERSION}
  script:
    - npm ci --cache .npm --prefer-offline
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# Run tests
test:
  stage: test
  image: node:${NODE_VERSION}
  dependencies:
    - install_dependencies
  script:
    - npm test -- --watchAll=false --ci || echo "No tests found or tests failed"
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    when: always
    paths:
      - coverage/
    expire_in: 1 week
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# Build the application
build:
  stage: build
  image: node:${NODE_VERSION}
  dependencies:
    - install_dependencies
  script:
    - npm run build
  artifacts:
    paths:
      - build/
    expire_in: 1 week
  only:
    - main
    - develop
    - merge_requests

# Deploy to staging environment
deploy_staging:
  stage: deploy
  image: node:${NODE_VERSION}
  dependencies:
    - build
  script:
    - echo "Deploying to staging environment..."
    # Add your staging deployment commands here
    # Examples:
    # - npm install -g firebase-tools
    # - firebase deploy --only hosting:staging --token $FIREBASE_TOKEN
    # OR
    # - scp -r build/* user@staging-server:/var/www/html/
    # OR
    # - rsync -avz build/ user@staging-server:/var/www/html/
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - develop
  when: manual

# Deploy to production environment
deploy_production:
  stage: deploy
  image: node:${NODE_VERSION}
  dependencies:
    - build
  script:
    - echo "Deploying to production environment..."
    # Add your production deployment commands here
    # Examples:
    # - npm install -g firebase-tools
    # - firebase deploy --only hosting --token $FIREBASE_TOKEN
    # OR
    # - scp -r build/* user@production-server:/var/www/html/
    # OR
    # - rsync -avz build/ user@production-server:/var/www/html/
    # OR for AWS S3:
    # - apt-get update && apt-get install -y awscli
    # - aws s3 sync build/ s3://your-bucket-name --delete
    # - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DIST_ID --paths "/*"
  environment:
    name: production
    url: https://production.example.com
  only:
    - main
  when: manual

# Optional: Lint stage
lint:
  stage: test
  image: node:${NODE_VERSION}
  dependencies:
    - install_dependencies
  script:
    - npm run build 2>&1 | tee lint-output.txt || true
    # React Scripts includes ESLint in the build process
    - echo "Linting completed"
  artifacts:
    paths:
      - lint-output.txt
    expire_in: 1 week
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

